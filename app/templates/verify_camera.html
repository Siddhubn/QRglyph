<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRglyph - Camera QR Verification</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='qrglyph_logo.png') }}">
</head>
<body>
    <nav class="navbar">
        <a href="/home" class="{% if request.path == '/home' %}active{% endif %}">Home</a>
        <a href="/" class="{% if request.path == '/' %}active{% endif %}">Single QR</a>
        <a href="/multi" class="{% if request.path.startswith('/multi') %}active{% endif %}">Multi</a>
        <a href="/verify" class="{% if request.path == '/verify' %}active{% endif %}">Image</a>
        <a href="/verify/camera" class="{% if request.path == '/verify/camera' %}active{% endif %}">Camera</a>
    </nav>
    <div class="page-wrapper">
      <div class="container">
        <div class="app-header">
            <img src="{{ url_for('static', filename='qrglyph_logo.png') }}" alt="QRglyph logo" class="app-logo">
            <h1>Camera QR Verification</h1>
        </div>
        <div id="camera-section">
            <div class="video-wrapper">
                <video id="video" playsinline autoplay muted></video>
                <canvas id="canvas" width="640" height="480" style="display:none"></canvas>
                <div class="scanner-overlay">
                        <div class="scan-frame">
                            <div class="corner tl"></div>
                            <div class="corner tr"></div>
                            <div class="corner bl"></div>
                            <div class="corner br"></div>
                            <div class="scan-bar" aria-hidden="true"></div>
                            <div class="pulse" aria-hidden="true"></div>
                            <div class="progress-ring" aria-hidden="true">
                                <svg width="56" height="56" viewBox="0 0 56 56" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="28" cy="28" r="24" stroke-opacity="0.06"></circle>
                                    <circle class="progress" cx="28" cy="28" r="24" stroke-dasharray="150" stroke-dashoffset="150"></circle>
                                </svg>
                            </div>
                        </div>
                </div>
            </div>
            <div class="camera-controls">
                <div class="status-row">
                    <div id="status" class="status-bubble">Initializing camera...</div>
                    <button id="retry-btn" class="btn ghost" style="display:none;">Retry</button>
                </div>
            </div>
            <form id="qr-form" method="POST" style="display:none;">
                <input type="hidden" id="qr-content" name="qr-content">
            </form>
            <div id="scan-result" class="scan-result"></div>
            <div id="consent-area" style="display:none;max-width:520px;margin:0.6rem auto;text-align:center"></div>
            <div style="display:flex;justify-content:center;margin-top:0.6rem;">
                <button id="rescan-btn" class="btn ghost" style="display:none;">Rescan</button>
            </div>
        </div>
        {% if result %}
            {% if result.error %}
                <div class="warning" style="color: #ff0033; font-weight: bold; margin-top:1em;">{{ result.error }}</div>
            {% else %}
                <div class="qr-card" style="margin-top:2em;">
                    <div class="trust-score trust-{{ result.trust.score }}">
                        <span style="font-size: 2rem;">{{ result.trust.icon }}</span>
                        <strong>{{ result.trust.score|capitalize }}</strong>
                        <ul>
                        {% for reason in result.trust.reasons %}
                            <li>{{ result.trust.reasons[loop.index0] }}</li>
                        {% endfor %}
                        </ul>
                    </div>
                    <div class="qr-decoded">
                        <strong>Decoded Content:</strong>
                        <pre style="background: #111; color: #0f0; padding: 0.5em; border-radius: 8px;">{{ result.decoded }}</pre>
                    </div>
                </div>
            {% endif %}
        {% endif %}
        <div class="link-row" role="navigation" aria-label="secondary navigation">
            <a href="/verify">← Upload QR</a>
            <span class="sep">|</span>
            <a href="/">Single QR Gen</a>
            <span class="sep">|</span>
            <a href="/multi">Multi QR Gen</a>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
    // Camera and QR scan logic (always-on; rescan to reactivate)
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const scanResult = document.getElementById('scan-result');
    const consentArea = document.getElementById('consent-area');
    const rescanBtn = document.getElementById('rescan-btn');
    const retryBtn = document.getElementById('retry-btn');
    const statusEl = document.getElementById('status');

    let lastDetected = '';
    let stream = null;
    let scanning = false;
    let paused = false; // pause scanning after a detection until user interacts

    async function startCamera(){
        if (scanning) return;
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
            statusEl.textContent = 'Camera not supported';
            return;
        }
        try{
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } });
            video.srcObject = stream;
            await video.play();
            scanning = true;
            paused = false;
            statusEl.textContent = 'Scanning...';
            rescanBtn.style.display = 'none';
            requestAnimationFrame(scanLoop);
        } catch(err){
            console.warn('startCamera error', err);
            statusEl.textContent = 'Camera access denied or unavailable';
            scanResult.innerHTML = '<div class="warning">Camera access denied or not available.</div>';
            if (retryBtn) retryBtn.style.display = 'inline-flex';
        }
    }

    function pauseForResult(){
        paused = true;
        statusEl.textContent = 'Paused — scan result';
        rescanBtn.style.display = 'inline-flex';
    }

    function resumeScan(){
        if (!scanning){
            startCamera();
            return;
        }
        paused = false;
        lastDetected = '';
        scanResult.innerHTML = '';
        consentArea.style.display = 'none';
        rescanBtn.style.display = 'none';
        statusEl.textContent = 'Scanning...';
        // reset overlay visuals
        const overlay = document.querySelector('.scanner-overlay');
        const progressEl = document.querySelector('.progress-ring .progress');
        if (overlay) overlay.classList.remove('detected');
        if (progressEl){
            try{
                const len = progressEl.getTotalLength();
                progressEl.style.transition = 'none';
                progressEl.style.strokeDasharray = len;
                progressEl.style.strokeDashoffset = len;
            }catch(e){}
        }
        requestAnimationFrame(scanLoop);
    }

    async function verifyContent(scanned){
        try{
            statusEl.textContent = 'Verifying...';
            const resp = await fetch('/api/verify_qr', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({qr_content: scanned})
            });
            if (!resp.ok){
                const txt = await resp.text();
                scanResult.innerHTML = '<div class="warning">Verification failed.</div>';
                console.error('verify error', txt);
                return;
            }
            const data = await resp.json();
            handleVerificationResult(data, scanned);
        } catch(e){
            console.error(e);
            scanResult.innerHTML = '<div class="warning">Verification request failed.</div>';
        }
    }

    function handleVerificationResult(data, scanned){
        const trust = data.trust || {};
        const score = (trust.score || 'unknown');
        // Show a result card
        let html = '<div class="result-card">';
        if (score === 'safe'){
            html += '<div style="color:var(--accent);font-weight:800;font-size:1.05rem;">✔ Safe</div>';
        } else if (score === 'suspicious'){
            html += '<div style="color:var(--danger);font-weight:800;font-size:1.05rem;">⚠ Suspicious</div>';
        } else if (score === 'dangerous'){
            html += '<div style="color:var(--danger);font-weight:900;font-size:1.05rem;">✖ Dangerous</div>';
        } else {
            html += '<div style="font-weight:800;">Result: ' + escapeHtml(score) + '</div>';
        }
        // show limited details
        if (trust.reasons && trust.reasons.length){
            html += '<ul style="text-align:left;margin:.5rem 0 0 1rem;color:var(--muted);">';
            for (const r of trust.reasons.slice(0,6)) html += '<li>' + escapeHtml(r) + '</li>';
            html += '</ul>';
        }
        html += '</div>';
        scanResult.innerHTML = html;

        // paused state and show consent/rescan depending on score
        pauseForResult();
        // keep detected visuals until rescan
        const overlay = document.querySelector('.scanner-overlay');
        if (overlay) overlay.classList.add('detected');

        if (score === 'safe' && data.is_url && data.url){
            // Immediately redirect to the safe URL
            try{
                statusEl.textContent = 'Safe — redirecting...';
                window.location.assign(data.url);
            }catch(e){
                // Fallback: set href which should also navigate
                window.location.href = data.url;
            }
            return;
        }

        if (score === 'suspicious' && data.is_url && data.url){
            // show consent interface with visible URL
            consentArea.style.display = 'block';
            consentArea.innerHTML = `
                <div class="qr-card">
                  <div style="font-weight:800;color:var(--muted);">Suspicious link detected</div>
                  <div style="margin-top:.5rem;word-break:break-all;">${escapeHtml(data.url)}</div>
                  <div style="margin-top:.6rem;display:flex;gap:.6rem;justify-content:center">
                    <button id="consent-go" class="btn">Proceed</button>
                    <button id="consent-no" class="btn ghost">Cancel</button>
                  </div>
                </div>
            `;
            document.getElementById('consent-go').addEventListener('click', ()=>{ window.location.href = data.url; });
            document.getElementById('consent-no').addEventListener('click', ()=>{ location.reload(); });
            return;
        }

        if (score === 'dangerous'){
            // Do not reveal URL. Show strong warning and keep user in page.
            consentArea.style.display = 'block';
            consentArea.innerHTML = `
                <div class="qr-card">
                  <div style="font-weight:900;color:var(--danger);">Dangerous link blocked</div>
                  <div style="margin-top:.5rem;color:var(--muted);">This QR code points to a link that was classified as dangerous and will not be opened.</div>
                </div>
            `;
            return;
        }

        // If not a URL or unknown, just show decoded content (if available)
        if (data.decoded){
            const d = '<div class="result-card" style="margin-top:.6rem;text-align:left"><strong>Decoded:</strong><pre class="decoded-pre">' + escapeHtml(data.decoded) + '</pre></div>';
            scanResult.innerHTML += d;
        }
    }

    function scanLoop(){
        if (!scanning || paused) return;
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        if (canvas.width === 0 || canvas.height === 0){
            requestAnimationFrame(scanLoop);
            return;
        }
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
        const overlay = document.querySelector('.scanner-overlay');
        const progressEl = document.querySelector('.progress-ring .progress');
        if (code && code.data && code.data !== lastDetected){
            lastDetected = code.data;
            statusEl.textContent = 'QR detected — verifying...';
            // show detected visuals
            if (overlay) overlay.classList.add('detected');
            if (progressEl){
                try{
                    const len = progressEl.getTotalLength();
                    progressEl.style.transition = 'none';
                    progressEl.style.strokeDasharray = len;
                    progressEl.style.strokeDashoffset = len;
                    // animate to 0 to indicate progress
                    setTimeout(()=>{ progressEl.style.transition = 'stroke-dashoffset .45s linear'; progressEl.style.strokeDashoffset = 0; }, 30);
                }catch(e){/* ignore */}
            }
            verifyContent(code.data);
        } else {
            statusEl.textContent = 'Scanning...';
        }
        if (!paused) requestAnimationFrame(scanLoop);
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    rescanBtn.addEventListener('click', resumeScan);
    if (retryBtn) retryBtn.addEventListener('click', function(){
        retryBtn.style.display = 'none';
        statusEl.textContent = 'Requesting camera...';
        startCamera();
    });

    // Always try to auto-start camera for convenience
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
        startCamera();
    } else {
        statusEl.textContent = 'Camera not supported in this browser.';
    }

    </script>
</body>
</html>
