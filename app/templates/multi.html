<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRglyph - Multi QR Generator</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='qrglyph_logo.png') }}">
</head>
<body>
    <nav class="navbar">
        <a href="/home" class="{% if request.path == '/home' %}active{% endif %}">Home</a>
        <a href="/" class="{% if request.path == '/' %}active{% endif %}">Single QR</a>
        <a href="/multi" class="{% if request.path.startswith('/multi') %}active{% endif %}">Multi</a>
        <a href="/verify" class="{% if request.path == '/verify' %}active{% endif %}">Image</a>
        <a href="/verify/camera" class="{% if request.path == '/verify/camera' %}active{% endif %}">Camera</a>
    </nav>
        <div class="page-wrapper">
            <div class="container">
        <div class="app-header">
            <img src="{{ url_for('static', filename='qrglyph_logo.png') }}" alt="QRglyph logo" class="app-logo">
            <h1>Multi QR Generator</h1>
        </div>
        <form method="POST" enctype="multipart/form-data" id="multi-form">
            <div class="form-row">
                <label for="num_qrs">Number of QRs to generate (1-10):</label>
                <select id="num_qrs" name="num_qrs" class="inline-select">
                    {% for n in range(1, 11) %}
                        <option value="{{n}}" {% if form_data and form_data|length == n %}selected{% endif %}>{{n}}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="qr-inputs" class="multi-grid">
                {% set num = form_data|length if form_data else 1 %}
                {% for i in range(num) %}
                {% set item = form_data[i] if form_data and (form_data|length > i) else {} %}
                <div class="input-card">
                    <label>Label:
                        <input type="text" name="label_{{i+1}}" value="{{ item['label'] | default('') }}">
                    </label>
                    <label>Text/URL:
                        <input type="text" name="qr-content_{{i+1}}" value="{{ item['qr-content'] | default('') }}">
                    </label>
                    <label>Color:
                        <input type="color" name="qr-color_{{i+1}}" value="{{ item['qr-color'] | default('#000000') }}">
                    </label>
                </div>
                {% endfor %}
            </div>
            <button type="submit" class="btn generate-btn">Generate All</button>
        </form>
        <script>
        // Dynamically update number of QR input blocks
        document.getElementById('num_qrs').addEventListener('change', function() {
            const n = parseInt(this.value);
            const form = document.getElementById('multi-form');
            // Remove all but num_qrs hidden inputs
            for (let i = form.elements.length - 1; i >= 0; i--) {
                const el = form.elements[i];
                if (el.name && (el.name.startsWith('label_') || el.name.startsWith('qr-content_') || el.name.startsWith('qr-color_')))
                    el.value = '';
            }
            form.submit();
        });
        </script>
        {% if qr_results %}
        <div class="multi-grid">
            {% for qr in qr_results %}
            <div class="qr-card">
                <div class="qr-label">{{ qr.label }}</div>
                <img src="data:image/png;base64,{{ qr.qr_image }}" alt="QR Code" class="qr-image">
                <div class="trust-score trust-{{ qr.trust.score }}">
                    <div style="display:flex;align-items:center;gap:.6rem">
                      <span class="trust-icon">{{ qr.trust.icon }}</span>
                      <strong>{{ qr.trust.score|capitalize }}</strong>
                    </div>
                    <ul>
                    {% for reason in qr.trust.reasons %}
                        <li>{{ reason }}</li>
                    {% endfor %}
                    </ul>
                    <button type="button" class="collapse-btn" onclick="toggleDetails('trust-details-{{ loop.index0 }}')">
                        <span id="arrow-trust-details-{{ loop.index0 }}">‚ñº</span> Show Details
                    </button>
                    <div id="trust-details-{{ loop.index0 }}" class="trust-details-collapsible">
                        <pre class="trust-details-pre">{{ qr.trust.details | default({}) | tojson(indent=2) }}</pre>
                        <div class="trust-info">
                            <strong>How trust is scored:</strong>
                            <div>This QR code was analyzed <b>locally</b> using pattern-based checks. No data was sent to any external service or API.</div>
                            <ul>
                                <li>Checks for suspicious keywords, file extensions, and URL shorteners</li>
                                <li>Flags long URLs, many subdomains, or use of IP addresses</li>
                                <li>Detects homoglyphs and other risky patterns</li>
                            </ul>
                            <span class="small-muted">Your privacy is protected: all trust analysis is performed on your device.</span>
                        </div>
                    </div>
                </div>
                {% if qr.trust.score != 'safe' %}
                    <div class="warning">Warning: Download disabled.</div>
                {% endif %}
                <div class="qr-controls">
                    <button class="btn secondary" onclick="readQRContent('{{ qr['qr-content']|e }}')">üîä Read</button>
                    <button id="share-{{ loop.index0 }}" class="btn" onclick='shareQR("{{ qr.qr_image }}", "{{ qr.decoded|e }}")' {% if qr.trust.score != 'safe' %}disabled{% endif %}>üì§ Share</button>
                    <button id="download-{{ loop.index0 }}" class="btn" onclick="downloadQR('{{ qr.qr_image }}','{{ qr.label|replace(' ','_') }}.png')" {% if qr.trust.score != 'safe' %}disabled{% endif %}>‚¨áÔ∏è Download</button>
                </div>
                <div id="consent-{{ loop.index0 }}" class="consent-slot" aria-live="polite"></div>
                <div class="qr-decoded">
                    <strong>Decoded:</strong>
                    <pre class="decoded-pre">{{ qr.decoded }}</pre>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
                <div class="link-row" role="navigation" aria-label="secondary navigation">
                    <a href="/verify">‚Üê Upload QR</a>
                    <span class="sep">|</span>
                    <a href="/">Single QR Gen</a>
                </div>
            </div>
        </div>
    <script src="{{ url_for('static', filename='main.js') }}"></script>
<script>
function toggleDetails(id) {
    var el = document.getElementById(id);
    var arrow = document.getElementById('arrow-' + id);
    if (el.style.display === 'none') {
        el.style.display = 'block';
        arrow.textContent = '‚ñ≤';
    } else {
        el.style.display = 'none';
        arrow.textContent = '‚ñº';
    }
}

// Share QR code for the user-provided content, not the decoded result
function shareQR(qrImage, userContent) {
    if (navigator.share) {
        fetch('data:image/png;base64,' + qrImage)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], 'qrglyph.png', { type: 'image/png' });
                navigator.share({
                    title: 'QRglyph',
                    text: 'Scan this QR for: ' + userContent,
                    files: [file]
                });
            });
    } else {
        alert('Sharing is not supported on this device/browser.');
    }
}
// Download helper (same as index)
function downloadQR(dataB64, filename){
    try{
        const byteString = atob(dataB64);
        const ia = new Uint8Array(byteString.length);
        for (let i=0;i<byteString.length;i++) ia[i]=byteString.charCodeAt(i);
        const blob = new Blob([ia], {type:'image/png'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || 'qrglyph.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }catch(e){
        alert('Download failed');
    }
}

// Setup consent prompts for suspicious multi QR cards
document.addEventListener('DOMContentLoaded', function(){
    {% if qr_results %}
    {% for qr in qr_results %}
        (function(){
            const idx = {{ loop.index0 }};
            const score = '{{ qr.trust.score }}';
            if (score === 'suspicious'){
                const el = document.getElementById('consent-' + idx);
                if (!el) return;
                el.style.display = 'block';
                const decoded = `{{ qr.decoded|e }}`;
                el.innerHTML = `
                    <div class="qr-card" style="padding:.5rem">
                      <div style="font-weight:800;color:var(--muted);">Suspicious link detected</div>
                      <div style="margin-top:.4rem;word-break:break-all;">${decoded}</div>
                      <div style="margin-top:.5rem;display:flex;gap:.5rem;justify-content:center">
                        <button id="consent-go-`+idx+`" class="btn">Proceed</button>
                        <button id="consent-no-`+idx+`" class="btn ghost">Cancel</button>
                      </div>
                    </div>
                `;
                document.getElementById('consent-go-' + idx).addEventListener('click', function(){
                    const s = document.getElementById('share-' + idx);
                    const d = document.getElementById('download-' + idx);
                    if (s) s.disabled = false;
                    if (d) d.disabled = false;
                    el.innerHTML = '<div style="color:var(--muted);font-weight:700">Proceeding ‚Äî options enabled.</div>';
                });
                document.getElementById('consent-no-' + idx).addEventListener('click', function(){
                    el.innerHTML = '<div style="color:var(--danger);font-weight:800">Cancelled. Share & Download remain disabled.</div>';
                });
            } else if (score === 'dangerous'){
                const s = document.getElementById('share-' + {{ loop.index0 }});
                const d = document.getElementById('download-' + {{ loop.index0 }});
                if (s) s.disabled = true;
                if (d) d.disabled = true;
            }
        })();
    {% endfor %}
    {% endif %}
});
</script>
</body>
</html>
